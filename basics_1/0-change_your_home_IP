#!/usr/bin/env bash
# Rewrite /etc/hosts so localhost -> 127.0.0.2 and facebook.com -> 8.8.8.8

tmp_file="$(mktemp)"

awk '
BEGIN {
  # put the new localhost mapping first so it takes precedence
  print "127.0.0.2 localhost"
}
{
  keep = 1
  # drop exact IPv4 localhost mapping lines
  if ($1 == "127.0.0.1") {
    for (i = 2; i <= NF; i++) if ($i == "localhost") { keep = 0; break }
  }
  # drop any line that mentions facebook.com as a field
  if (keep == 1) {
    for (i = 1; i <= NF; i++) if ($i == "facebook.com") { keep = 0; break }
  }
  if (keep == 1) print
}
END {
  print "8.8.8.8 facebook.com"
}
' /etc/hosts > "$tmp_file"

# overwrite without in-place rename (avoids sed -i issues)
cat "$tmp_file" > /etc/hosts
rm -f "$tmp_file"
